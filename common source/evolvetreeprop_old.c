double evolvetreeprop(int OTUs, double *MBL, int FOSSILS){long	attempts, base=100000, speciation;int		a, b, c, d, ee, charstandard, ch, latest, mxdv=6, brats;int		otu, sampled, initdiv, standingdiv, cumulativediv, stage, newby;int		species, anc, change;int		reboot;int		sp;int		mxtaxa, mxstnd;int		*f1, *ancestor;int		*extants, *observed, *bl;int		*fa, *la;double	mu, lmbd, fr, vr, frp;double	speciate, extinct, find;double	*tor, *tex;double	v, x, y, mod;mu=MBL[0];lmbd=MBL[1];fr=MBL[2];vr=MBL[3];if (vr<1)	vr=MBL[3]=1.0f;speciation=MBL[4];v=expectedpropsampled(MBL[1],MBL[2]);v=1/v;mxtaxa=10*v*OTUs;/*if (FOSSILS=1)	mxstnd=2*OTUs;	*//*else			mxstnd=3*OTUs;		*/mxstnd=3*OTUs;/* arrays for observed taxa - set to OTUs*/observed=ivector(OTUs);		/* observed (sampled) taxa 					*/fa=ivector(OTUs);			/* first appearance of a taxon				*/la=ivector(OTUs);			/* last appearance of a taxon				*/bl=ivector(2*OTUs);			/* array for all elements of the tree 		*/extants = ivector(mxstnd+1);	/* array for standing taxa - set to mxstnd*/	/* arrays for sampled and unsampled taxa - set to mxtaxa */ancestor=ivector(mxtaxa);	/* ancestor of each taxon 					*/f1=ivector(mxtaxa);			/* number of descendants for each taxon 	*/tor=dvector(mxtaxa);		/* true origination - this is a real number */tex=dvector(mxtaxa);		/* true extinction - this is a real number 	*/reboot=0;a=b=c=d=ee=anc=0;charstandard = 1; /*charbase/100;*/sp = ch = change = find = 0;clearivector(observed,OTUs,-1);clearivector(ancestor,mxtaxa,-1);clearivector(extants,mxstnd+1,-1);latest = -1;attempts = initdiv = standingdiv = cumulativediv = stage = extants[0] = sampled = 0;/* use this to calculate how long the species will live */extinct=(((unsigned int) rand())%RAND_MAX)/((double) RAND_MAX);		/*added 2014-01-13	*/while (extinct<=0)	extinct=(((unsigned int) rand())%RAND_MAX)/((double) RAND_MAX);tex[0]=(log(1-extinct)/log(1-lmbd));tor[0]=0.0f;		/*added 2014-01-13	*/while (sampled < OTUs)	{	initdiv = standingdiv+1;	for (sp=0; (sp<=standingdiv && cumulativediv<mxtaxa); ++sp)	{	/********************************************/	/*			Does Lineage Speciate?			*/	/********************************************/		if (sp<0 || sp>mxstnd)	{			printf("ERROR 108: %d is the wrong number of species!\n", sp);			exit(0);			}		species = extants[sp];/*		mod=1.0f;	*//*		if (tor[species]>stage)	*//*			mod=(stage+1)-tor[species];	/* mod reflects shortened time for extinction and speciation *//*		/*		v=1-pow((1-lmbd),mod);	/* this will equal lmbd if it survives the whole interval *//*		/* if v is still less than extinction rate, then the species dies this interval *//*		if (extinct<v)	{*//*			/* now randomly generate a number to show when it dies *//*			x=(((unsigned int) rand())%RAND_MAX)/((double) RAND_MAX);*//*			/* if it existed at the beginning		*//*			if (tor[species]<=stage)	tex[species]+=x;*//*			/* if it originated durign this stage	*/ /*			else						tex[species]+=x*(((double) (stage+1))-tor[species]);*//*			}*//*		/* if it survies, then bump the extinction to the next interval	*//*		else							tex[species]=stage+1;	*/				if (f1[species]<mxdv)	speciate = (((unsigned int) rand())%RAND_MAX)/((double) RAND_MAX);		else					speciate = 1.0f;				/* do this to shake up random number generator */		if (sp%2==0)			speciate=1-speciate;		v=mu;		if (tex[species]<(stage+1) || tor[species]>stage)	{			if (tex[species]<(stage+1) && tor[species]>stage)											mod=tex[species]-tor[species];			else if (tor[species]<stage)	mod=tex[species]-stage;			else if (tex[species]>stage+1)	mod=((double) (stage+1))-tor[species];			v=1-pow((1-mu),mod);	/* this will equal mu if it survives the whole interval */			}		if (speciation==1)	ee=2;		else				ee=1;		if (speciate <= v && (standingdiv<(mxstnd-ee)))		{			brats=1;			/* if bifurcation, then two descendants when ancestor disappears		*/			if (speciation==1)	brats=2;			/* if budding, then allow for multiple descendants at different times 	*/			else	{				if (tor[species]>stage)	v=(stage+1)-tor[species];				else					v=1;				x=Poisson(mu, v, 2);				if (v<x)				brats=2;				}			/* go through each descendant */			for (a=0; a<brats; ++a)	{				++standingdiv;				++cumulativediv;				extants[standingdiv] = cumulativediv;				if (cumulativediv > mxtaxa)	{					printf("ERROR Evolve 180 - In replication XXX");					printf(", more than %3d species were generated.  \n",mxtaxa);					sampled=OTUs;					exit(0);						}				if (standingdiv<0 || standingdiv>mxstnd)	{					printf("ERROR 186:  Standing diversity too high at %2d\n",standingdiv);					sampled=OTUs;					exit(0);						}							if (cumulativediv<0 || cumulativediv>=mxtaxa || species<0 || species>=mxtaxa)	{					printf("ERROR 191 - ancestor index out of range at %d and %d\n",species,cumulativediv);					sampled=OTUs;					exit(0);						}				ancestor[cumulativediv] = species;				anc = species;				++f1[anc];						/*******************************************************************************/		/* Ancestors become pseudo-extinct at bifurcation if that is what is happening */		/*******************************************************************************/				if (speciation==0 || (speciation==1 && a==0))	{					y=(((unsigned int) rand())%RAND_MAX)/((double) RAND_MAX);					/* if ancestor originated during stage and extends into the next	*/					if (tex[anc]>stage+1 && tor[anc]>stage)						tor[cumulativediv]=tor[anc]+(y*((stage+1)-tor[anc]));					/* if ancestor goes extinct during stage and originated before it	*/					else if (tex[anc]<(stage+1) && tor[anc]<stage)						tor[cumulativediv]=stage+(y*(tex[anc]-stage));					/* if ancestor both originates and goes extinct during stage		*/					else if (tex[anc]<(stage+1) && tor[anc]>stage)						tor[cumulativediv]=tor[anc]+(y*(tex[anc]-tor[anc]));					else						tor[cumulativediv]=y+ ((double) stage);										/* if we are dealing with the first species of a bifurcation, give it ancestral extinction time.	*/					/* 		Ancestor disappears when descendants arise													*/ 					if (speciation==1)	{						tex[cumulativediv]=tex[anc];						tex[anc]=tor[cumulativediv];						}					}				/* second species of a bifurcation */				else if (a==1)	tor[cumulativediv]=tex[anc];								/* establish extinction if the species becomes extinct */				if (speciation==0 || (speciation ==1 && a==1))	{					/* if we are dealing with the second species, then give it its own extinction time but the same origination time */					extinct=(((unsigned int) rand())%RAND_MAX)/((double) RAND_MAX);					tex[cumulativediv]=tor[cumulativediv]+(log(1-extinct)/log(1-lmbd));					}				}			}		if (FOSSILS==0 && standingdiv>=OTUs-1)	sp = initdiv;	/* quit if enough taxa are alive */		}	/****  End Speciation Round ****/ 				if (FOSSILS==1)	{		/********************************************/		/*				 Do Sampling				*/		/*  Separated from Speciation Loop 1/3/97   */		/********************************************/		if (sampled < OTUs)	{			for (sp=0; sp<=standingdiv; ++sp)	{				species = extants[sp];								/* Raw Species Number *//*				find = (((unsigned int) rand())%base)+1;	*//*				if (f1[species]>=3 || cumulativediv>=(3*mxstnd))	find = 0;	*/				find=(((unsigned int) rand())%RAND_MAX)/((double) RAND_MAX);				/* do this to shake up the random number generator */				if (sp%2==0)	find=1-find;								v=fr;				frp=log(1-fr);				/* 2012-01-10: Poisson expectation so that P[0 | 1 stage, fr] = 1=fr	*/											/* keep this here so that we can handle variable sampling				*/				if (tex[species]<(stage+1) || tor[species]>stage)	{					/* if species originates and disappears in this interval 			*/					if (tex[species]<(stage+1) && tor[species]>stage)														mod=tex[species]-tor[species];					/* if species originated earlier but goes extinct in this interval	*/					else if (tex[species]<(stage+1))	mod=tex[species]-stage;					/* if species goes extinct later but originates in this interval	*/					else if (tex[species]>(stage+1))	mod=((double) (stage+1))-tor[species];//					v=1-pow(1-(fr*vfr),mod);					v=1-pow((1-fr),mod);	/* this will equal fr*vfr if it survives the whole interval */												/*	(1-[fr*vfr]) = prob. of missing over whole interval													(1-[fr*vfr])^mod = prob. of missing over mod.  	*/					}						if (find <= v)	{					newby = 0;					/** First sampled species goes straight into the array **/					if (sampled==0)	{						observed[sampled]=species;						fa[sampled]=la[sampled]=stage;						++sampled;						}					/** Test whether a sampled species had gone unsampled **/					else	{						for (otu = 0; otu < sampled;  ++otu)	{							if (observed[otu] == species)	{								newby = 1;		/* species is not new */								la[otu]=stage;								otu = sampled;								}							}						if (newby == 0 && sampled < OTUs)	{							/* sort species as you go */							a=sampled-1;							while (observed[a]>species && a>=0)	{								observed[a+1]=observed[a];								fa[a+1]=fa[a];								la[a+1]=la[a];								--a;								}							observed[a+1] = species;							fa[a+1]=la[a+1]=stage;							++sampled;							if (sampled<0 || sampled>OTUs)	{								printf("ERROR 189: You somehow sampled %d\n",sampled);								exit(0);								}							if (sampled==OTUs)		sp = standingdiv;							}						}					latest = observed[sampled-1];					}	/* End Tallying of Sampled Horizon	*/				}	/*  End Sampling for Each Horizon	*/			}	/* only do test while we need to sampled taxa */		}	/* only sample if we are including fossils	*/			else {		sampled = standingdiv;		/* if there are no fossils, "present" is when									   OTUs taxa evolve */		if (sampled==OTUs-1)	for (sp=0; sp<OTUs; ++sp)	observed[sp]=extants[sp];		}	if (sampled>=OTUs)	break;	/* don't bother with the rest if done */			/* cull species that went extinct */	for (a=0; a<=standingdiv; ++a)	{		sp=extants[a];		if (tex[sp]<(stage+1))	{			for (b=a+1; b<=standingdiv; ++b)	extants[b-1]=extants[b];			extants[standingdiv]=-1;			--standingdiv;			--a;			}		}		initdiv=standingdiv;				/****** REBOOT ROUTINE ******/	if (standingdiv < 0 || (cumulativediv>=mxtaxa && sampled < OTUs))	{		latest = -1;		/* clear vectors set to maxtaxa */		for (sp=0; sp<cumulativediv; ++sp)			ancestor[sp]=tex[sp]=tor[sp]=f1[sp]=-1;		/* clear vectors set to OTUs */		for (sp=0; sp<sampled; ++sp)			fa[sp]=la[sp]=observed[sp]=-1;				standingdiv = initdiv = cumulativediv = extants[0] = sampled = 0;		stage = 0;		++attempts;		/* use this to calculate how long the species will live */		extinct=(((unsigned int) rand())%RAND_MAX)/((double) RAND_MAX);		tex[0]=(log(1-extinct)/log(1-lmbd));		tor[0]=0.0f;		/*added 2014-01-13	*//*		if ((attempts%5)==0)	printf ("%2d tries and counting.\n",attempts); */		}				/** Reboot simulation **/	else	{		if (sampled < OTUs)	++stage;		/*  All OTUs species found	*/		else if (FOSSILS==0 && cumulativediv==((2*OTUs)-2))	{			for (sp=0; sp<=standingdiv; ++sp)		observed[sp] = extants[sp];			sampled = OTUs;			reboot=1;			}		/* if species index is out of range, then reboot the whole thing */		}	}	free_ivector(observed);free_ivector(fa);free_ivector(la);free_ivector(bl);free_ivector(extants);free_ivector(ancestor);free_ivector(f1);free_dvector(tor);free_dvector(tex);	return ((double) (OTUs-1))/((double) latest-1);}