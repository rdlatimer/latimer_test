double *wholecladedisparitytaxa(double **PWDis, int notu, long **ranges, int onset, int term){int	s, t, s1, s2, sp1, sp2;int quar1=0, quar2=1, quar3=2, cog=3;double	x, M;double y, z, zz, zzz;double *accumdisp, *reldisp, *sumdisp;int	*rich, **evolved;double *results;accumdisp=dvector((term-onset)+1);reldisp=dvector((term-onset)+1);sumdisp=dvector((term-onset)+1);rich=ivector((term-onset)+1);evolved=imatrix((term-onset)+1,notu);results=dvector(5);cleardvector(results,5,-1);/* find which species appear by which "stage"	*/for (s=0; s<notu; ++s)	{	for (t=ranges[s][0]; t<=term; ++t)	{		evolved[t][rich[t]]=s;	/* cummulative taxa	*/		++rich[t];				/* cummulative richness	*/		}	}	/* end richness tallying	*/for (t=onset; t<=term; ++t)	{	for (s1=0; s1<(rich[t]-1); ++s1)	{		sp1=evolved[t][s1];					/* first species	*/		for (s2=s1+1; s2<rich[t]; ++s2)	{			sp2=evolved[t][s2];				/* second species	*/			accumdisp[t]+=PWDis[sp1][sp2];	/* sum pairwise dissimilarities	*/			}		}	/* now, get average	*/	if (rich[t]>1)	accumdisp[t]/=(((double) ((rich[t]*rich[t])-rich[t]))/2);	else			accumdisp[t]=0.0f;	}	/* end cumulative disparity tallying *//* reset disparity to 1.0 for all comparisons	/* Note to self: should I add*/for (t=onset; t<=term; ++t)	{	reldisp[t]=accumdisp[t]/accumdisp[term];	if (t==onset)	sumdisp[t]=reldisp[t];	else			sumdisp[t]=sumdisp[t-1]+reldisp[t];/*	if (results[quar1]==-1 && reldisp[t]>=0.25)	results[quar1]=((double) rich[t])/((double) notu);	if (results[quar2]==-1 && reldisp[t]>=0.50)	results[quar2]=((double) rich[t])/((double) notu);	if (results[quar3]==-1 && reldisp[t]>=0.75)	results[quar3]=((double) rich[t])/((double) notu);	*/	if (results[quar1]==-1 && reldisp[t]>=0.25)	{		if (t>onset)	{			y=reldisp[t]-reldisp[t-1];			x=log(rich[t])-log(rich[t-1]);			M=(reldisp[t]-reldisp[t-1])/(log(rich[t])-log(rich[t-1]));			z=(0.25-reldisp[t-1])/M;									/* how much disparity is added to get to 0.25 divided by slope	*/			zz=log(rich[t-1])+z;										/* log of richness passing 0.25	*/			zzz=exp(zz);												/* richness passing 0.25		*/			results[quar1]=exp(log(rich[t-1])+((0.25-reldisp[t-1])/M));				results[quar1]/=((double) notu);			}	/* end case where 25% found after first interval	*/		else	{//			y=reldisp[t];//			x=log(rich[t]);//			M=y/x;			M=(reldisp[t])/log(rich[t]);//			z=0.25/M;			results[quar1]=exp(0.25/M);			results[quar1]/=((double) notu);			}	/* end case where 25% found in first interval	*///		results[quar1]=((double) rich[t])/((double) notu);		}	/* end search for richness generating 25% of disparity	*/	if (results[quar2]==-1 && reldisp[t]>=0.50)	{		if (t>onset)	{//			y=reldisp[t]-reldisp[t-1];//			x=log(rich[t])-log(rich[t-1]);//			M=y/x;			/* shift in disparity against shift in log richness	*/			M=(reldisp[t]-reldisp[t-1])/(log(rich[t])-log(rich[t-1]));			/* change in disparity to get to 0.25 divided by slope: that is the extra taxa	*///			z=(0.5-reldisp[t-1]);//			zz=z/M;//			zz=(0.5-reldisp[t-1])/M;//			zzz=log(rich[t-1])+zz;//			zzz=log(rich[t-1])+((0.5-reldisp[t-1])/M);//			results[quar2]=exp(zzz);			results[quar2]=exp(log(rich[t-1])+((0.5-reldisp[t-1])/M));			results[quar2]/=((double) notu);//			M=(reldisp[t]-reldisp[t-1])/(log(rich[t]-log(rich[t-1])));			}	/* end case where 50% found after first interval	*/		else	{//			y=reldisp[t];//			x=log(rich[t]);//			M=y/x;			M=(reldisp[t])/log(rich[t]);//			z=0.5/M;			results[quar2]=exp(0.5/M);			results[quar2]/=((double) notu);			}	/* end case where 50% found in first interval	*///		results[quar2]=((double) rich[t])/((double) notu);		}	/* end search for richness generating 50% of disparity	*/	if (results[quar3]==-1 && reldisp[t]>=0.75)	{		if (t>onset)	{			M=(reldisp[t]-reldisp[t-1])/(log(rich[t])-log(rich[t-1]));			results[quar3]=exp(log(rich[t-1])+((0.75-reldisp[t-1])/M));			results[quar3]/=((double) notu);			}	/* end case where 75% found after first interval	*/		else	{//			y=reldisp[t];//			x=log(rich[t]);//			M=y/x;			M=(reldisp[t])/log(rich[t]);//			z=0.75/M;			results[quar3]=exp(0.75/M);			results[quar3]/=((double) notu);			}	/* end case where 75% found in first interval	*/		}	/* end search for richness generating 75% of disparity	*/	}	//x=sumdisp[term]/2;x=((double) notu)/2;for (t=onset; t<term; ++t)	{//	if (sumdisp[t]<x && sumdisp[t+1]>=x)	{//		results[cog]=((double) rich[t+1])/((double) notu);//		t=term;//		}	if (rich[t]==x)	results[cog]=reldisp[t];	if (rich[t]<x && rich[t+1]>x)	{		if (t>onset)	{			z=log(x)-log(rich[t]);										/* richness shift	*/			y=(reldisp[t+1]-reldisp[t]);									/* disparity shift	*/			M=(reldisp[t+1]-reldisp[t])/(log(rich[t+1])-log(rich[t]));	/* slope			*/			results[cog]=reldisp[t]+(log(x)-log(rich[t]))*M;			}		else	{			M=reldisp[t]/log(rich[t]);	/* slope			*/			results[cog]=log(x)*M;			}		t=term;		}	}free_ivector(rich);free_imatrix(evolved,(term-onset)+1,notu);free_dvector(accumdisp);free_dvector(reldisp);free_dvector(sumdisp);return(results);}